---
title: "Imputation Primer"
output:
  html_document:
    df_print: paged
---

## Handling Missing Data: Some Imputation Schemes

Missing data is a pervasive and often nontrivial problem in data handling and analytics. 

If the amount of missing data is << size of overall dataset, dropping those rows maybe OK. Else, significant info loss may happen.

While some quick fixes such as mean-substitution may sometimes be fine, risk of introducing bias into the data remains.

There are two types of missing data: MCAR and MNAR.  
MCAR: missing completely at random. This is the desirable scenario in case of missing data.  
MNAR: missing not at random. Missing not at random data is a more serious issue and in this case it might be wise to check the data gathering process further and try to understand why the information is missing. 
For instance, if most of the people in a survey did not answer a certain question, why did they do that? Was the question unclear?  

A number of packages, funcs, approaches in R (and elsewhere) help deal with missing data. This primer will do a quick test-drive using 3 packages - `Hmisc`, `VM` and `mice`. 

The last package - `mice` - stands for *Multiple Imputations using Chained Expressions* and will be the show-stealer towards the end.

So first off, let me setup the stage here.

```{r setup}

 # load libraries needed
suppressPackageStartupMessages({
  suppressWarnings({
  
 if (!(require(Hmisc))) {install.packages("Hmisc")};    library(Hmisc)
 if (!(require(VIM))) {install.packages("VIM")};    library(VIM)
 if (!(require(mice))) {install.packages("mice")};    library(mice)
 if (!(require(magrittr))) {install.packages("magrittr")};    library(magrittr)
  })
})  
```
Simple things first.

### Basic Imputations in R with Hmisc::impute()

In what follows I use `with()` in conjuction with `impute()` from `Hmisc` to replace missing values with different common alternatives.  

```{r Hmisc runs}
# build toy dataset for demo
DF <- data.frame(age = c(10, 20, NA, 40), sex = c('male','female'))

# impute with mean value
DF$imputed_age <- with(DF, impute(age, mean))

# impute with random value
DF$imputed_age2 <- with(DF, impute(age, 'random'))

# impute with the median
with(DF, impute(age, median))

# impute with the minimum
with(DF, impute(age, min))

# impute with the maximum
with(DF, impute(age, max))

# Impute with a constant (say, the number 7)
with(DF, impute(age, 7))

# impute with letter 'a'
with(DF, impute(age, 'a'))
```
### Using k-nearest neighbors (kNN)

Another simple (and often effective) approach is to use kNNs to ID the rows that most closely resemble the target rows (i.e., tho with missing data) and replacing the missing field with the group-mean of the kNNs.

See example below of using the func `VIM::kNN()`. The dataset is `sleep` (internally available) and there are a number of columns with missing values.  

The code below replaces missing values in variables "NonD" and "Gest".

```{r knn}

## using VIM::kNN()
 data(sleep)
 str(sleep)

 # Try ?kNN for  func parms
 a0 = kNN(sleep, variable = c("NonD","Gest"))
 str(a0)    # compare with str(sleep)
## ---------------
```

### Imputing with MICE

Quoting from the package documentation:
> The mice package in R, helps you imputing missing values with plausible data values. These plausible values are drawn from a distribution specifically designed for each missing datapoint.

So what is MICE anyway?   MICE is:  

[1] Multivariate imputation: in that it creates multiple imputations (replacement values) for multivariate missing data   

[2] using **chained equations** i.e. each missing value is conditional on the other missing values creating a chain.  

MICE uses a *Fully conditional specification* wherein each incomplete variable is imputed by a separate model *conditional* on the values of the other variables.   

The Full conditionals are then cycled to convergence hence the `maxit` parameter in the function. P.S. Sort of Bayesian in design. 

```{r mice}
## get the nhanes dataset
dat <- mice::nhanes    # try '?nhanes'
str(dat)    # colms are {age, bmi, hypertensive (Y/N), serum cholestrol}
summary(dat)
```

Looking at the dataset above, the Q arises, "Which variables are missing in which rows in conjunction with which other variables?"    

The mice package offers a handy `md.pattern()` func to help. See below.

P.S.: A perhaps more helpful visual representation to get an idea about the above Q can be obtained using the `VIM` package, also as follows.

```{r vim display}
# looking at missing data pattern using md.pattern()
md.pattern(dat)

## ----------

library(VIM)
aggr_plot <- aggr(dat, 

		# display parms
		col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(dat), 

		# graphical parms
		cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
```
Notice above, there's zero NAs in the 'age' variable whereas 'chl' and 'bmi' report highest NAs.  

And now, time to use MICE's `impute()` func. 

MICE offers upto 3 imputation methods in its `defaultMethod` parameter:   

[1] *pmm* or predicted mean meatching (default method),   
[2] *logreg*, logistic regression imputation (binary data, factor with 2 levels)   
[3] *polyreg*, polytomous regression imputation for unordered categorical data (factor >= 2 levels), and   
[4] *polr*, proportional odds model for (ordered, >= 2 levels).

Thus, it is a powerful func that covers most variable types we'll expect to find.

```{r mice_impute}
# using mice::mice() to impute
system.time({
  imp <- mice(dat,     # data
		m = 3,        # no. of multiple imputations
		print=F)
  })    # 0.41 secs
 class(imp)    # a 'mids' object 0 output list with 18 elements
```
Time to impute the missing values and see, now.

```{r complete}
imputed_dataset_1<-complete(imp, 1)   # Fills in missing vals in tgt dataset. Try '?complete'.
head(imputed_dataset_1)
head(dat)    # compare with orig dataset
```
Now, let's see what methods have been used to impute each column

```{r $method}
meth<-imp$method
meth
```
Notice how age doesn't have an imputation method for it. That's because there were no NAs in that column.  

OTOH, Columns bmi, hyp and chl are going to be imputed with pmm (predictive mean matching)

Let's say that we want to impute only the "hyp" column. Then, we set the methods for the bmi and chl column to "" and leave 'hyp' to have the default of 'pmm', thus:
```{r meth}
meth[c(2,4)]<-""
meth

# Run the mice imputation again, resetting the methods parm to modified method 'meth'
imp <- mice(mice::nhanes, m = 3, print=F, method = meth)
partly_imputed_dataset_1 <- complete(imp, 3)
head(partly_imputed_dataset_1)
```
OK. This is it from me for now.

Qs to recap: [1] What is imputation? Why should we care? What various methods did we see in this markdown? What various packages? Etc.

Sudhir